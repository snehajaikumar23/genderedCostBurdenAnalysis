# Results

```{r}
library(tidyverse)
library(purrr)
library(stringr)
library(ggplot2)
library(dplyr)
library(tidyr)

# Load consumer expenditure data
consumer_expenditure_females_2019 <- read_excel('/Users/snehajaikumar/EDAV/cu-singles-by-age-single-females-2019.xlsx')

header <- as.character(consumer_expenditure_females_2019[2, ])

header <- header |>
  str_replace_all("\\r\\n", " ") |>  # replace CRLF newlines with a space
  str_squish() 

colnames(consumer_expenditure_females_2019) <- header

start_main <- 47
start_sources <- which(grepl("Sources of income", consumer_expenditure_females_2019$Item))
start_addenda <- which(grepl("Addenda", consumer_expenditure_females_2019$Item))

df_main    <- consumer_expenditure_females_2019[start_main:(start_sources - 1), ]
df_sources <- consumer_expenditure_females_2019[start_sources:(start_addenda - 1), ]
df_addenda <- consumer_expenditure_females_2019[start_addenda:219, ]

major_groups_main <- c(
  "Food", "Housing", "Apparel and services", "Transportation", "Healthcare", "Entertainment","Education","Alcoholic beverages","Reading","Cash contributions","Personal insurance and pensions", "Tobacco products and smoking supplies", "Miscellaneous","Personal care products and services"
)

major_groups_sources <- c(
  "Money income before taxes", "Personal taxes (contains some imputed values)", "Income after taxes"
)

major_groups_addenda <- c(
  "Gifts of goods and services, total", "Net change in total assets and liabilities", "Other financial information:"
)

numeric_cols <- setdiff(names(df_main), "Item")
df_main_clean <- df_main |>
  mutate(
    level1 = if_else(Item %in% major_groups_main, Item, NA_character_)
  ) |>
  tidyr::fill(level1, .direction = "down") |>
  filter(rowSums(!is.na(across(all_of(numeric_cols)))) > 0)

df_sources_clean <- df_sources |>
  mutate(
    level1 = if_else(Item %in% major_groups_sources, Item, NA_character_)
  ) |>
  tidyr::fill(level1, .direction = "down") |>
  filter(rowSums(!is.na(across(all_of(numeric_cols)))) > 0)

df_addenda_clean <- df_addenda |>
  mutate(
    level1 = if_else(Item %in% major_groups_addenda, Item, NA_character_)
  ) |>
  tidyr::fill(level1, .direction = "down") |>
  filter(rowSums(!is.na(across(all_of(numeric_cols)))) > 0)


df_main_clean
df_sources_clean 
df_addenda_clean

```

```{r}
# Clean each table by removing commas, letters, and quotes, as well as making values numeric
df_main_clean <- df_main_clean |>
  mutate(across(
    -c(Item, level1),  # numeric columns only
    ~ {
      x <- .

      # Remove commas in numbers
      x <- str_replace_all(x, ",", "")

      # Replace pure letters (a, b, c) with NA
      x <- ifelse(str_detect(x, "^[abc]$"), NA, x)

      # For values like "c/ 13" extract the numeric part
      x <- str_replace(x, "^[abc]/\\s*", "")

      # Convert to numeric
      as.numeric(x)
    }
  ))

df_sources_clean <- df_sources_clean |>
  mutate(across(
    -c(Item, level1),  # numeric columns only
    ~ {
      x <- .

      # Remove commas in numbers
      x <- str_replace_all(x, ",", "")

      # Replace pure letters (a, b, c) with NA
      x <- ifelse(str_detect(x, "^[abc]$"), NA, x)

      # For values like "c/ 13" extract the numeric part
      x <- str_replace(x, "^[abc]/\\s*", "")

      # Convert to numeric
      as.numeric(x)
    }
  ))

df_addenda_clean <- df_addenda_clean |>
  mutate(across(
    -c(Item, level1),  # numeric columns only
    ~ {
      x <- .

      # Remove commas in numbers
      x <- str_replace_all(x, ",", "")

      # Replace pure letters (a, b, c) with NA
      x <- ifelse(str_detect(x, "^[abc]$"), NA, x)

      # For values like "c/ 13" extract the numeric part
      x <- str_replace(x, "^[abc]/\\s*", "")

      # Convert to numeric
      as.numeric(x)
    }
  ))
```

```{r}
df_top <- df_main_clean |>
  filter(Item == level1)

df_top_long <- df_top |>
  pivot_longer(
    cols = -c(Item, level1),
    names_to = "age_group",
    values_to = "expenditure"
  ) 

df_top_long_all_females <- df_top_long |>
  filter(age_group == "All single females")

# FIRST PLOT
ggplot(df_top_long_all_females, aes(x = reorder(level1, expenditure),
                        y = expenditure)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(title = "Total Expenditures by Category (Single Females, 2018–2019)",
       x = "Category", y = "Annual Spending ($)")

df_top_long <- df_top_long |>
  filter(age_group != "All single females") |>
  mutate(
    age_group = factor(
      age_group,
      levels = c(
        "Under 25 years",
        "25-34 years",
        "35-44 years",
        "45-54 years",
        "55-64 years",
        "65 years and older"
      ),
      ordered = TRUE
    )
  )
```

```{r}
# SECOND PLOT
ggplot(df_top_long, aes(x = age_group, y = expenditure, fill = level1)) +
  geom_col(position = "dodge") +
  labs(title = "Expenditures by Age Group (Females)",
       x = "", y = "Annual Spending ($)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
df_prop <- df_top_long |>
  group_by(age_group) |>
  mutate(prop = expenditure / sum(expenditure)) |>
  ungroup()

# THIRD PLOT
ggplot(df_prop, aes(x = age_group, y = prop, fill = level1)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "Set3") +
  labs(title = "Budget Composition by Age Group (Single Females, 2018–2019)",
       x = "Age Group", y = "Percent of Total Budget") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
df_food <- df_main_clean |>
  filter(Item %in% c("Food at home", "Food away from home")) |>
  pivot_longer(cols = -c(Item, level1),
               names_to = "age_group",
               values_to = "expenditure") |>
  filter(age_group != "All single females") |>
  mutate(
    age_group = factor(
      age_group,
      levels = c(
        "Under 25 years",
        "25-34 years",
        "35-44 years",
        "45-54 years",
        "55-64 years",
        "65 years and older"
      ),
      ordered = TRUE
    )
  )

#FOURTH PLOT
ggplot(df_food, aes(age_group, expenditure, color = Item, group = Item)) +
  geom_line(size = 1.3) +
  geom_point(size = 3) +
  labs(title = "Food at Home vs Food Away From Home (Females)",
       y = "Annual Spending ($)", x = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



```{r}
#Repeat for males
# Load consumer expenditure data
consumer_expenditure_males_2019 <- read_excel('/Users/snehajaikumar/EDAV/cu-singles-by-age-single-males-2019.xlsx')

header <- as.character(consumer_expenditure_males_2019[2, ])

header <- header |>
  str_replace_all("\\r\\n", " ") |>  # replace CRLF newlines with a space
  str_squish() 

colnames(consumer_expenditure_males_2019) <- header

start_main <- 47
start_sources <- which(grepl("Sources of income", consumer_expenditure_males_2019$Item))
start_addenda <- which(grepl("Addenda", consumer_expenditure_males_2019$Item))

df_main    <- consumer_expenditure_males_2019[start_main:(start_sources - 1), ]
df_sources <- consumer_expenditure_males_2019[start_sources:(start_addenda - 1), ]
df_addenda <- consumer_expenditure_males_2019[start_addenda:219, ]

major_groups_main <- c(
  "Food", "Housing", "Apparel and services", "Transportation", "Healthcare", "Entertainment","Education","Alcoholic beverages","Reading","Cash contributions","Personal insurance and pensions", "Tobacco products and smoking supplies", "Miscellaneous","Personal care products and services"
)

major_groups_sources <- c(
  "Money income before taxes", "Personal taxes (contains some imputed values)", "Income after taxes"
)

major_groups_addenda <- c(
  "Gifts of goods and services, total", "Net change in total assets and liabilities", "Other financial information:"
)

numeric_cols <- setdiff(names(df_main), "Item")
df_main_clean <- df_main |>
  mutate(
    level1 = if_else(Item %in% major_groups_main, Item, NA_character_)
  ) |>
  tidyr::fill(level1, .direction = "down") |>
  filter(rowSums(!is.na(across(all_of(numeric_cols)))) > 0)

df_sources_clean <- df_sources |>
  mutate(
    level1 = if_else(Item %in% major_groups_sources, Item, NA_character_)
  ) |>
  tidyr::fill(level1, .direction = "down") |>
  filter(rowSums(!is.na(across(all_of(numeric_cols)))) > 0)

df_addenda_clean <- df_addenda |>
  mutate(
    level1 = if_else(Item %in% major_groups_addenda, Item, NA_character_)
  ) |>
  tidyr::fill(level1, .direction = "down") |>
  filter(rowSums(!is.na(across(all_of(numeric_cols)))) > 0)


df_main_clean
df_sources_clean 
df_addenda_clean
```


```{r}
# Continue for males
# Clean each table by removing commas, letters, and quotes, as well as making values numeric
df_main_clean <- df_main_clean |>
  mutate(across(
    -c(Item, level1),  # numeric columns only
    ~ {
      x <- .

      # Remove commas in numbers
      x <- str_replace_all(x, ",", "")

      # Replace pure letters (a, b, c) with NA
      x <- ifelse(str_detect(x, "^[abc]$"), NA, x)

      # For values like "c/ 13" extract the numeric part
      x <- str_replace(x, "^[abc]/\\s*", "")

      # Convert to numeric
      as.numeric(x)
    }
  ))

df_sources_clean <- df_sources_clean |>
  mutate(across(
    -c(Item, level1),  # numeric columns only
    ~ {
      x <- .

      # Remove commas in numbers
      x <- str_replace_all(x, ",", "")

      # Replace pure letters (a, b, c) with NA
      x <- ifelse(str_detect(x, "^[abc]$"), NA, x)

      # For values like "c/ 13" extract the numeric part
      x <- str_replace(x, "^[abc]/\\s*", "")

      # Convert to numeric
      as.numeric(x)
    }
  ))

df_addenda_clean <- df_addenda_clean |>
  mutate(across(
    -c(Item, level1),  # numeric columns only
    ~ {
      x <- .

      # Remove commas in numbers
      x <- str_replace_all(x, ",", "")

      # Replace pure letters (a, b, c) with NA
      x <- ifelse(str_detect(x, "^[abc]$"), NA, x)

      # For values like "c/ 13" extract the numeric part
      x <- str_replace(x, "^[abc]/\\s*", "")

      # Convert to numeric
      as.numeric(x)
    }
  ))
```

```{r}
# Continue for males....
# Clean each table by removing commas, letters, and quotes, as well as making values numeric
df_main_clean <- df_main_clean |>
  mutate(across(
    -c(Item, level1),  # numeric columns only
    ~ {
      x <- .

      # Remove commas in numbers
      x <- str_replace_all(x, ",", "")

      # Replace pure letters (a, b, c) with NA
      x <- ifelse(str_detect(x, "^[abc]$"), NA, x)

      # For values like "c/ 13" extract the numeric part
      x <- str_replace(x, "^[abc]/\\s*", "")

      # Convert to numeric
      as.numeric(x)
    }
  ))

df_sources_clean <- df_sources_clean |>
  mutate(across(
    -c(Item, level1),  # numeric columns only
    ~ {
      x <- .

      # Remove commas in numbers
      x <- str_replace_all(x, ",", "")

      # Replace pure letters (a, b, c) with NA
      x <- ifelse(str_detect(x, "^[abc]$"), NA, x)

      # For values like "c/ 13" extract the numeric part
      x <- str_replace(x, "^[abc]/\\s*", "")

      # Convert to numeric
      as.numeric(x)
    }
  ))

df_addenda_clean <- df_addenda_clean |>
  mutate(across(
    -c(Item, level1),  # numeric columns only
    ~ {
      x <- .

      # Remove commas in numbers
      x <- str_replace_all(x, ",", "")

      # Replace pure letters (a, b, c) with NA
      x <- ifelse(str_detect(x, "^[abc]$"), NA, x)

      # For values like "c/ 13" extract the numeric part
      x <- str_replace(x, "^[abc]/\\s*", "")

      # Convert to numeric
      as.numeric(x)
    }
  ))
```

```{r}
df_top <- df_main_clean |>
  filter(Item == level1)

df_top_long <- df_top |>
  pivot_longer(
    cols = -c(Item, level1),
    names_to = "age_group",
    values_to = "expenditure"
  ) 

df_top_long_all_males <- df_top_long |>
  filter(age_group == "All single males")

# FIRST PLOT
ggplot(df_top_long_all_males, aes(x = reorder(level1, expenditure),
                        y = expenditure)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(title = "Total Expenditures by Category (Single Males, 2018–2019)",
       x = "Category", y = "Annual Spending ($)")

df_top_long <- df_top_long |>
  filter(age_group != "All single males") |>
  mutate(
    age_group = factor(
      age_group,
      levels = c(
        "Under 25 years",
        "25-34 years",
        "35-44 years",
        "45-54 years",
        "55-64 years",
        "65 years and older"
      ),
      ordered = TRUE
    )
  )
```

```{r}
# SECOND PLOT
ggplot(df_top_long, aes(x = age_group, y = expenditure, fill = level1)) +
  geom_col(position = "dodge") +
  labs(title = "Expenditures by Age Group (Males)",
       x = "", y = "Annual Spending ($)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
df_prop <- df_top_long |>
  group_by(age_group) |>
  mutate(prop = expenditure / sum(expenditure)) |>
  ungroup()

# THIRD PLOT
ggplot(df_prop, aes(x = age_group, y = prop, fill = level1)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Budget Composition by Age Group (Single Males, 2018–2019)",
       x = "Age Group", y = "Percent of Total Budget") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
df_food <- df_main_clean |>
  filter(Item %in% c("Food at home", "Food away from home")) |>
  pivot_longer(cols = -c(Item, level1),
               names_to = "age_group",
               values_to = "expenditure") |>
  filter(age_group != "All single males") |>
  mutate(
    age_group = factor(
      age_group,
      levels = c(
        "Under 25 years",
        "25-34 years",
        "35-44 years",
        "45-54 years",
        "55-64 years",
        "65 years and older"
      ),
      ordered = TRUE
    )
  )

#FOURTH PLOT
ggplot(df_food, aes(age_group, expenditure, color = Item, group = Item)) +
  geom_line(size = 1.3) +
  geom_point(size = 3) +
  labs(title = "Food at Home vs Food Away From Home (Males)",
       y = "Annual Spending ($)", x = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
df_top_long_all_males <- df_top_long_all_males %>%
  mutate(gender = "Male")
df_top_long_all_females <- df_top_long_all_females %>%
  mutate(gender = "Female")

df_top_long_all_females


df_diff <- df_top_long_all_males %>%
  select(level1, expenditure) %>%
  mutate(gender = "Male") %>%
  bind_rows(
    df_top_long_all_females %>%
      select(level1, expenditure) %>%
      mutate(gender = "Female")
  ) %>%
  pivot_wider(names_from = gender, values_from = expenditure) %>%
  mutate(diff = Female - Male)

ggplot(df_diff, aes(x = reorder(level1, diff), y = diff)) +
  geom_col(fill = ifelse(df_diff$diff > 0, "firebrick", "steelblue")) +
  coord_flip() +
  labs(
    title = "Gender Difference in Annual Spending (Female – Male), 2018–2019",
    x = "Category",
    y = "Difference in Spending ($)"
  ) +
  theme_minimal()


df_both <- bind_rows(df_top_long_all_males, df_top_long_all_females)
ggplot(df_both, aes(x = reorder(level1, expenditure), y = expenditure, fill = gender)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  facet_wrap(~ gender, ncol = 2) +
  labs(
    title = "Total Expenditures by Category (Single Males vs Single Females, 2018–2019)",
    x = "Category",
    y = "Annual Spending ($)"
 )

```

```{r}
#Load in all 20 datasets for single females and males from 2009-2019
library(tidyverse)
# install.packages("janitor")
library(janitor)


files <- list.files("/Users/snehajaikumar/EDAV/final_datasets", pattern = "*.xlsx", full.names = TRUE)
manual_header <- c(
  "Item",
  "All",
  "Under 25 years",
  "25-34 years",
  "35-44 years",
  "45-54 years",
  "55-64 years",
  "65 years and older"
)

clean_numeric <- function(x) {
  x |>
    str_replace("^[abc]/\\s*", "") |>   # remove a/, b/, c/ and any space after
    na_if("") |>                       # empty string → NA
    as.numeric()
}


read_cex_file <- function(filepath) {

  # Extract gender + year using regex
  gender <- if (str_detect(filepath, "females")) "Female" else "Male"
  year   <- str_extract(filepath, "\\d{4}") |> as.numeric()

  # Read raw
  raw <- read_excel(filepath, col_names = FALSE)

  # Extract row 3 as header
  # header <- as.character(raw[2, ])
  # header[header == "" | is.na(header)] <- paste0("unknown_", seq_len(sum(header == "" | is.na(header))))
  names(raw) <- manual_header

  # Add metadata
   df <- raw |>
      slice(47:229) |>       # <— keep only rows 47–183
      janitor::remove_empty("cols") |>
      filter(!(Item != "" & if_all(-Item, is.na))) |> filter(Item != "Average annual expenditures")
      # filter(!if_all(everything(), is.na)) |>   # <— remove fully-NA rows
   
   gift_start <- which(df$Item %in% c("Gifts of goods and services",
                                   "Gifts of goods and services, total"))
   gift_end   <- which(df$Item == "All other gifts")
   
   

  if (length(gift_start) == 1 && length(gift_end) == 1) {
    df <- df[-(gift_start:gift_end), ]
  }
   
    df <- df |> mutate(
        gender = gender,
        year = year
      ) |>
     mutate(across(-c(Item, gender, year), clean_numeric)) 
  

  return(df)
}

df_main <- map_df(files, read_cex_file)

# gift_start <- which(df_all$Item == "Gifts of goods and services")
# gift_end   <- which(df_all$Item == "All other gifts")
# df_gifts <- df_all[gift_start:gift_end, ]
# df_main <- df_all[-(gift_start:gift_end), ]

df_main



```


```{r}
library(dplyr)
library(tidyr)

df_long <- df_main |>
  pivot_longer(
    cols = -c(Item, gender, year),  
    names_to = "age_group",
    values_to = "expenditure"
  ) |>
  mutate(
    age_group = factor(
      age_group,
      levels = c(
        "All",
        "Under 25 years",
        "25-34 years",
        "35-44 years",
        "45-54 years",
        "55-64 years",
        "65 years and older"
      ),
      ordered = TRUE
    )
  )

df_missing <- df_long

df_long <- df_long |>
  mutate(
    Item = case_when(
      Item %in% c("Gasoline, other fuels, and motor oil",
                  "Gasoline and motor oil") ~ "Gasoline & motor oil",
      Item %in% c("Public transportation",
                  "Public and other transportation") ~ "Public transportation",
      Item %in% c("Males, 2 and over",
                  "Men and boys") ~ "Men and boys",
      Item %in% c("Boys, 2 to 15", "Men, 16 and over") ~ "Men and boys",
      Item %in% c("Females, 2 and over",
                  "Women and girls") ~ "Women and girls",
      Item %in% c("Girls, 2 to 15", "Women, 16 and over") ~ "Women and girls",
      
      TRUE ~ Item
    )
  )

df_long

```
```{r}
df_hi <- df_long |>
  filter(Item %in% c("Housing", "Income after taxes"))

df_hi

df_hi_wide <- df_hi |>
  pivot_wider(
    names_from = Item,
    values_from = expenditure
  )

df_hi_wide


df_hi_wide <- df_hi_wide %>%
  mutate(housing_burden = Housing / `Income after taxes`) #|> mutate(year = factor(year))

df_hi_wide

```
```{r}
ggplot(df_hi_wide, aes(x = year, y = housing_burden, color = gender)) +
  geom_line(size = 1.2) +
  facet_wrap(~ age_group) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(breaks = seq(min(df_hi_wide$year), max(df_hi_wide$year), 1)) +
  labs(
    title = "Housing Burden Over Time (2009–2019)",
    y = "% of Income Spent on Housing",
    x = "Year"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5)
  )
```

```{r}
major_groups_main <- c(
  "Food", "Housing", "Apparel and services", "Transportation", "Healthcare",
   "Education","Cash contributions",
  "Personal insurance and pensions","Personal care products and services"
)

df_major <- df_long |> 
  filter(Item %in% major_groups_main)

df_gender_wide <- df_major |>
  pivot_wider(
    names_from = gender,
    values_from = expenditure
  )

df_gender_wide <- df_gender_wide |>
  mutate(
    gender_diff = Female - Male    # positive = women pay more
  )

ggplot(df_gender_wide |> filter(age_group == "All"),
       aes(x = year, y = gender_diff, color = Item)) +
  geom_line(size = 1, color = "steelblue") +
  facet_wrap(~ Item, scales = "free_y") +
  labs(
    title = "Gender Difference in Annual Spending (Female − Male)",
    subtitle = "2009–2019, Single Adults",
    x = "Year",
    y = "Difference in Spending ($)"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  ) +
  scale_x_continuous(breaks = seq(2009, 2019, 1))


```

```{r}

df_major_all <- df_major |> filter(age_group == "All")

df_mean <- df_major_all |>
  group_by(gender, Item) |>
  summarise(mean_expenditure = mean(expenditure, na.rm = TRUE), .groups = "drop")

df_diff <- df_mean |>
  pivot_wider(
    names_from = gender,
    values_from = mean_expenditure
  )

df_diff <- df_diff |>
  mutate(diff = Female - Male)

df_diff <- df_diff |> rename(level1 = Item)


ggplot(df_diff,
       aes(x = reorder(level1, diff),
           y = diff,
           fill = diff > 0)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("TRUE" = "firebrick", "FALSE" = "steelblue")) +
  labs(
    title = "Gender Spending Difference (Female − Male), Average 2009–2019",
    subtitle = "Positive values indicate categories where women spend more",
    x = "Category",
    y = "Difference in Average Annual Spending ($)",
    fill = ""
  ) +
  theme_minimal() +
  theme(legend.position = "none")


```
```{r}
transport_items <- c(
  "Cars and trucks, new",
  "Cars and trucks, used",
  "Other vehicles",
  "Gasoline & motor oil",
  "Vehicle finance charges",
  "Maintenance and repairs",
  "Vehicle rental, leases, licenses, and other charges",
  "Vehicle insurance",
  "Public transportation"
  
)

big_palette <- c(
  "#1b9e77", "#d95f02", "#7570b3", "#e7298a", "#66a61e",
  "#e6ab02", "#a6761d",  "#6a3d9a","#1f78b4"
)


df_transport <- df_long |>
  filter(Item %in% transport_items) |>
  filter(age_group == "All")

df_transport_summary <- df_transport |>
  group_by(year, gender, Item) |> 
  summarise(exp = mean(expenditure, na.rm = TRUE),
            .groups = "drop")

ggplot(df_transport_summary,
       aes(x = year, y = exp, color = Item)) +
  
  geom_line(size = 1.0, alpha = 0.9) +        # ← LINES
  geom_point(size = 2.2) +                    # ← DOTS ON EVERY POINT
  
  scale_color_manual(values = big_palette) +  # your 20-color palette
  
  facet_wrap(~ gender) +
  
  labs(
    title = "Transportation Spending Breakdown by Gender (2009–2019)",
    subtitle = "Lines show subcategory trends; dots show observed values",
    y = "Annual Spending ($)",
    x = "Year",
    color = "Category"
  ) +
  
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.key.size = unit(0.5, "cm"),
    legend.position = "right"
  ) +
  
  scale_x_continuous(breaks = seq(2009, 2019, 1))



target <- "Public transportation"

ggplot(df_transport_summary, aes(x = year, y = exp, group = Item)) +

  # 1. BASE LINES — dimmed for all non-target categories
  geom_line(
    data = df_transport_summary |> filter(Item != target),
    aes(color = "other"),
    size = 0.7,
    alpha = 0.35
  ) +

  # 2. TARGET LINE — bold & colored
  geom_line(
    data = df_transport_summary |> filter(Item == target),
    aes(color = target),
    size = 1.4
  ) +

  # 3. TARGET POINTS — emphasize observations
  geom_point(
    data = df_transport_summary |> filter(Item == target),
    aes(color = target),
    size = 3
  ) +

  facet_wrap(~ gender) +
  
  scale_x_continuous(breaks = seq(2009, 2019, 1)) +

  # 4. MANUAL COLORS
  scale_color_manual(
    name = "Category",
    values = c(
      "other" = "gray70",
      target = "#E41A1C"   # bold red highlight
    ),
    labels = c(
      "other" = "Other transportation categories",
      target = target
    )
  ) +

  labs(
    title = "Transportation Spending Breakdown (Highlighting Public Transportation)",
    subtitle = "Public transportation emphasized for clearer gender trends",
    x = "Year",
    y = "Annual Spending ($)"
  ) +

  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  )



```
```{r}
df_pc_income <- df_long |>
  filter(
    Item %in% c("Personal care products and services", "Income after taxes"),
  )


df_pc_income_wide <- df_pc_income |>
  select(year, gender, age_group, Item, expenditure) |>
  pivot_wider(
    names_from = Item,
    values_from = expenditure
  )

df_pc_income_wide <- df_pc_income |>
  select(year, gender, age_group, Item, expenditure) |>
  pivot_wider(
    names_from = Item,
    values_from = expenditure
  )

df_pc_income_wide <- df_pc_income_wide |>
  mutate(
    pct_budget_pc = `Personal care products and services` / `Income after taxes`
  )


ggplot(df_pc_income_wide,
       aes(x = year, y = pct_budget_pc, color = gender)) +

  geom_line(size = 1.2) +
  geom_point(size = 2.8) +

  scale_y_continuous(labels = scales::percent_format(accuracy = 0.1)) +
  scale_x_continuous(breaks = seq(2009, 2019, 1)) +

  scale_color_manual(values = c("Female" = "#E41A1C", "Male" = "#377EB8")) +

  facet_wrap(~ age_group) +

  labs(
    title = "Personal Care Spending as a % of Income After Taxes",
    subtitle = "By Gender and Age Group (2009–2019)",
    x = "Year",
    y = "Percent of After-Tax Income",
    color = "Gender"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 11, face = "bold")
  )


```
```{r}

apparel_items <- c(
  "Men and boys",
  "Women and girls",
  "Children under 2"
)


df_apparel_small <- df_long |>
  filter(
    Item %in% apparel_items,
    age_group %in% c("Under 25 years", "25-34 years")
  )

df_apparel_small$age_group <- factor(
  df_apparel_small$age_group,
  levels = c("Under 25 years", "25-34 years"),
  ordered = TRUE
)

df_apparel_small_combined <- df_apparel_small |>
  group_by(Item, gender, year, age_group) |>
  summarise(
    expenditure = sum(expenditure, na.rm = TRUE),
    .groups = "drop"
  )


df_apparel_small_combined


df_female <- df_apparel_small_combined |> filter(gender == "Female")

ggplot(df_female,
       aes(x = year, y = expenditure, color = Item)) +
  geom_line(size = 1.1) +
  geom_point(size = 2) +
  facet_wrap(~ age_group, scales = "free_y") +
  labs(
    title = "Female Apparel Spending Over Time",
    subtitle = "Under 25 and 25–34 age groups (2009–2019)",
    x = "Year",
    y = "Annual Spending ($)",
    color = "Apparel Category"
  ) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(breaks = seq(2009, 2019, 1)) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

df_male <- df_apparel_small_combined |> filter(gender == "Male")

ggplot(df_male,
       aes(x = year, y = expenditure, color = Item)) +
  geom_line(size = 1.1) +
  geom_point(size = 2) +
  facet_wrap(~ age_group, scales = "free_y") +
  labs(
    title = "Male Apparel Spending Over Time",
    subtitle = "Under 25 and 25–34 age groups (2009–2019)",
    x = "Year",
    y = "Annual Spending ($)",
    color = "Apparel Category"
  ) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(breaks = seq(2009, 2019, 1)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



ggplot(df_apparel_small_combined,
       aes(x = year, y = expenditure,
           color = gender, linetype = gender)) +
  geom_line(size = 1.1) +
  geom_point(size = 2) +
  facet_wrap(~ Item + age_group, scales = "free_y") +
  labs(
    title = "Male vs Female Apparel Spending, Side-by-Side",
    subtitle = "Each panel = one apparel subcategory × one age group",
    x = "Year",
    y = "Annual Spending ($)",
    color = "Gender",
    linetype = "Gender"
  ) +
  scale_color_manual(values = c(Female = "#E41A1C", Male = "#377EB8")) +
  scale_x_continuous(breaks = seq(2009, 2019, 1)) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, margin = margin(t = 10)),
    strip.text = element_text(face = "bold")
  )


```




```{r}
library(dplyr)
library(vcd)

health_items <- c(
  "Health insurance",
  "Medical services",
  "Drugs",
  "Medical supplies"
)

gender_colors <- c(Female = "#E41A1C", Male = "#377EB8")

#FIRST YEAR
df_mosaic_1 <- df_long |>
  filter(
    year == 2009,
    age_group == "All",
    Item %in% health_items
  ) |>
  select(Item, gender, expenditure) |>
  rename(Freq = expenditure)

# 1) Turn into a table of dollar amounts
tab <- xtabs(Freq ~ Item + gender, data = df_mosaic_1)

rownames(tab) <- recode(
  rownames(tab),
  "Health insurance" = "Insurance",
  "Medical services" = "   Serv",
  "Medical supplies" = "Supp"
)

mosaic(
  tab,
  labeling = labeling_values,
  labeling_args = list(
    labels = tab,   
    gp_text = gpar(cex = 0.9, col = "black")
  ),
  highlighting = "gender",
  highlighting_fill = gender_colors,
  direction = c("h", "v"),
  main = "Healthcare Spending by Gender (2009)",
  sub  = "Supp = Medical Supplies, Serv = Medical Services"
)



#SECOND YEAR
df_mosaic_2 <- df_long |>
  filter(
    year == 2016,
    age_group == "All",
    Item %in% health_items
  ) |>
  select(Item, gender, expenditure) |>
  rename(Freq = expenditure)

# 1) Turn into a table of dollar amounts
tab <- xtabs(Freq ~ Item + gender, data = df_mosaic_2)

rownames(tab) <- recode(
  rownames(tab),
  "Health insurance" = "Insurance",
  "Medical services" = "   Serv",
  "Medical supplies" = "Supp"
)

mosaic(
  tab,
  labeling = labeling_values,
  labeling_args = list(
    labels = tab,      
    gp_text = gpar(cex = 0.9, col = "black")
  ),
  highlighting = "gender",
  highlighting_fill = gender_colors,
  direction = c("h", "v"),
  main = "Healthcare Spending by Gender (2016)",
  sub  = "Supp = Medical Supplies, Serv = Medical Services"
)

#THIRD YEAR
df_mosaic_3 <- df_long |>
  filter(
    year == 2019,
    age_group == "All",
    Item %in% health_items
  ) |>
  select(Item, gender, expenditure) |>
  rename(Freq = expenditure)

# 1) Turn into a table of dollar amounts
tab <- xtabs(Freq ~ Item + gender, data = df_mosaic_3)

rownames(tab) <- recode(
  rownames(tab),
  "Health insurance" = "Insurance",
  "Medical services" = "   Serv",
  "Medical supplies" = "Supp"
)

mosaic(
  tab,
  labeling = labeling_values,
  labeling_args = list(
    labels = tab,        
    gp_text = gpar(cex = 0.9, col = "black")
  ),
  highlighting = "gender",
  highlighting_fill = gender_colors,
  direction = c("h", "v"),
  main = "Healthcare Spending by Gender (2019)",
  sub  = "Supp = Medical Supplies, Serv = Medical Services"
)


```

```{r}
df_missing
df_missing |>
  filter(is.na(expenditure)) |>
  count(Item, sort = TRUE) |>
  slice_head(n = 20) |>
  ggplot(aes(x = reorder(Item, n), y = n)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Items With the Most Missing Expenditure Values",
    x = "Item",
    y = "Number of Missing Values"
  ) +
  theme_minimal()



library(tidyverse)

top_items <- df_missing |>
  filter(is.na(expenditure)) |>
  count(Item, sort = TRUE) |>
  slice_head(n = 20) |>
  pull(Item)

df_missing |>
  filter(Item %in% top_items) |>
  mutate(is_missing = ifelse(is.na(expenditure), 1, 0)) |>
  count(Item, gender, wt = is_missing) |>
  ggplot(aes(x = gender, y = reorder(Item, n), fill = n)) +
  geom_tile(color = "white") +
  scale_fill_gradientn(
    colours = c("#DEEBF7","#9ABBDD","#4A7BBF","#08306B"),
    values = scales::rescale(c(0, 1, 5, max(df_heat$n_missing))),
    name = "Missing Count"
  )  +
  labs(
    title = "Heatmap of Missing Values by Item and Gender (Top 20 Items)",
    x = "Gender",
    y = "Item",
    fill = "Missing\nCount"
  ) +
  theme_minimal(base_size = 13)



library(tidyverse)

top_items <- df_missing |>
  filter(is.na(expenditure)) |>
  count(Item, sort = TRUE) |>
  slice_head(n = 20) |>
  pull(Item)

df_heat_item_age <- df_missing |>
  filter(Item %in% top_items) |>
  mutate(is_missing = ifelse(is.na(expenditure), 1, 0)) |>
  count(Item, age_group, wt = is_missing) |>
  mutate(n = as.integer(n)) |>
  complete(Item, age_group, fill = list(n = 0))

ggplot(df_heat_item_age,
       aes(x = age_group, y = reorder(Item, n), fill = n)) +
  geom_tile(color = "white") +
  scale_fill_gradient(
    low = "#deebf7",   # light blue
    high = "#08306b",
    name = "Missing\nCount"
  ) +
  labs(
    title = "Missing Expenditure Values by Item and Age Group",
    x = "Age Group",
    y = "Item"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))





```


```{r}

df_heat <- df_long |>
  mutate(is_missing = ifelse(is.na(expenditure), 1, 0)) |>
  group_by(age_group, gender) |>
  summarise(n_missing = sum(is_missing), .groups = "drop") |>
  complete(age_group, gender, fill = list(n_missing = 0))



ggplot(df_heat, aes(x = age_group, y = gender, fill = n_missing)) +
  geom_tile(color = "white") +
  scale_fill_gradient(
    low = "#deebf7",   # light blue
    high = "#08306b",
    name = "Missing Count"
  )  +
  labs(
    title = "Missing Values by Age Group and Gender",
    x = "Age Group",
    y = "Gender",
    #fill = "Missing Count"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```
