---
title: "kaushiki"
editor: visual
---

```{r}

library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)

file_path <- "datasets/healthcare_spendings.xlsx"

# Read Table 7
df <- read_excel(file_path, sheet = "Table 7", skip = 3) %>%
  select(1:11)

# RENAME "Age group" → "AgeGroup"
names(df)[1] <- "AgeGroup"

# Convert numeric columns
df[2:11] <- lapply(df[2:11], as.numeric)

# Locate Males and Females rows
male_start   <- which(df$AgeGroup == "Males")
female_start <- which(df$AgeGroup == "Females")

# Extract up to 10 rows below the header, keep rows with numeric values
extract_block <- function(start_row, df) {
  block <- df[(start_row+1):(start_row+10), ]
  block %>% filter(rowSums(!is.na(select(., 2:11))) >= 5)
}

male_block   <- extract_block(male_start, df)
female_block <- extract_block(female_start, df)

# Keep only the 5 specific age groups
target_groups <- c("0-18","19-44","45-64","65-84","85+")

male_clean <- male_block   %>% filter(AgeGroup %in% target_groups)
female_clean <- female_block %>% filter(AgeGroup %in% target_groups)

# Ensure correct order
male_clean$AgeGroup   <- factor(male_clean$AgeGroup,   levels = target_groups)
female_clean$AgeGroup <- factor(female_clean$AgeGroup, levels = target_groups)

# Long format
years <- c("2002","2004","2006","2008","2010","2012","2014","2016","2018","2020")

male_long <- male_clean %>%
  pivot_longer(all_of(years), names_to = "Year", values_to = "Male")

female_long <- female_clean %>%
  pivot_longer(all_of(years), names_to = "Year", values_to = "Female")

df_long <- male_long %>%
  left_join(female_long, by = c("AgeGroup","Year")) %>%
  mutate(
    Year = as.integer(Year),
    Gap = Female - Male
  )



df_gapplot <- df_long %>%
  mutate(FemaleAdj = Female - Male)

ggplot(df_gapplot, aes(x = AgeGroup)) +
  geom_col(aes(y = FemaleAdj, fill = Year), alpha = 0.4) +
  geom_hline(yintercept = 0, color = "black", size = 0.7) +
  facet_wrap(~Year, ncol = 5) +
  scale_fill_viridis_c() +
  labs(
    title = "Gender Healthcare Penalty (Female − Male Spending)",
    subtitle = "Bars above zero show years where women spent more per capita at each age",
    x = "Age Group",
    y = "Difference (USD)"
  ) +
  theme_minimal(base_size = 12)

```

```{r}

# Load required libraries
library(dplyr)
library(ggplot2)
library(patchwork)

#Compute average spending for each age group
df_avg <- df_long %>%
  group_by(AgeGroup) %>%
  summarise(
    AvgMale = mean(Male, na.rm = TRUE),
    AvgFemale = mean(Female, na.rm = TRUE),
    AvgGap = mean(Female - Male, na.rm = TRUE)
  )


# ==========================================
# DUMBBELL (AVERAGE MALE VS FEMALE)
# ==========================================

ggplot(df_avg, aes(y = AgeGroup)) +
  geom_segment(
    aes(x = AvgMale, xend = AvgFemale, y = AgeGroup, yend = AgeGroup),
    color = "gray60", size = 2
  ) +
  geom_point(aes(x = AvgMale), color = "steelblue", size = 4) +
  geom_point(aes(x = AvgFemale), color = "firebrick", size = 4) +
  labs(
    title = "Average Spending by Sex (2002–2020)",
    subtitle = "Dumbbell plot shows consistent gender differences",
    x = "Average Per-Capita Spending (USD)",
    y = ""
  ) +
  theme_minimal(base_size = 14)


#paired dot plot
df_avg_long <- df_avg %>%
  tidyr::pivot_longer(cols = c(AvgMale, AvgFemale),
                      names_to = "Sex",
                      values_to = "AvgSpend") %>%
  mutate(Sex = recode(Sex, "AvgMale" = "Male", "AvgFemale" = "Female"))



ggplot(df_avg_long, aes(x = AvgSpend, y = AgeGroup, color = Sex)) +
  geom_point(size = 4) +
  scale_color_manual(values = c("Male" = "steelblue", "Female" = "firebrick")) +
  labs(
    title = "Male vs Female Healthcare Spending (Average 2002–2020)",
    x = "Per Capita Spending (USD)",
    y = "",
    color = "Sex"
  ) +
  theme_minimal(base_size = 14)




```

```{r}


library(ggplot2)
library(dplyr)
library(tidyr)
library(plotly)      # for interactive graph

# Create GAP 
df_gap <- df_long %>%
  mutate(Gap = Female - Male)


# ===============================
# 10. INTERACTIVE PLOTLY: Gender Gap Over Time
# ===============================

p <- ggplot(df_gap, aes(x = Year, y = Gap, color = AgeGroup)) +
  geom_line(size = 1.3) +
  geom_point(size = 2) +
  labs(
    title = "Interactive Gender Gap in Healthcare Spending",
    x = "Year",
    y = "Female − Male (USD)"
  ) +
  theme_minimal(base_size = 14)

ggplotly(p)

```

Women incur higher per-capita healthcare spending than men at nearly every age group, especially in midlife and older adulthood. This pattern is consistent over the 2002–2020 period in CMS national expenditure data.

```{r}


library(readr)
library(dplyr)
library(ggplot2)

b1 <- read_csv("datasets/Natality_2003_2006.csv")
b2 <- read_csv("datasets/Natality_2007_2024.csv")

births_raw <- bind_rows(b1, b2)

#cleaning
births_clean <- births_raw %>%
  select(Age = `Age of Mother 9`, Births) %>%   # keep only important columns
  filter(!is.na(Age), Age != "Total") %>%       # remove total and missing rows
  group_by(Age) %>%
  summarise(Births = sum(Births, na.rm = TRUE)) %>%
  ungroup()


#reordering 
births_clean$Age <- factor(
  births_clean$Age,
  levels = c(
    "Under 15 years",
    "15-19 years",
    "20-24 years",
    "25-29 years",
    "30-34 years",
    "35-39 years",
    "40-44 years",
    "45-49 years",
    "50 years and over"
  )
)

ggplot(births_clean, aes(x = Age, y = Births)) +
  geom_col(fill = "green", alpha = 0.75) +
  labs(
    title = "U.S. Birth Counts by Maternal Age (2003–2024)",
    subtitle = "Births peak at ages 25–34 exactly where women's healthcare spending is highest",
    x = "Maternal Age Group",
    y = "Total Births (Across 21 Years)"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



ggplot(births_clean, aes(x = Age, y = Births, group = 1)) +
  geom_line(size = 1.4, color = "red") +
  geom_point(size = 3, color = "black") +
  labs(
    title = "Birth Distribution by Maternal Age",
    subtitle = "Reproductive-age women bear the biological burden that drives healthcare spending",
    x = "Age Group",
    y = "Total Births"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
